## **一、模块定位**

本模块为平台提供统一的用户认证与权限校验机制，确保：

- 所有接口访问都有明确身份（User / 信使 / 管理员 / 系统服务）
    
- 不同身份拥有不同的访问能力（RBAC）
    
- 安全地支持 API Token、OAuth2、JWT 等机制
    
- 保护用户隐私数据、系统配置与敏感操作不被越权访问
    

---

## **二、身份类型与角色权限**

|**角色类型**|**说明**|**核心权限示例**|
|---|---|---|
|匿名用户|未登录访问者|浏览公开信件、查看信封商城、注册|
|注册用户|普通平台用户|写信、绑定条码、查询自己的信、设置资料|
|信使（四级～一级）|信使角色（含等级信息）|查看/领取任务、扫码标记、点位管理、内部信件信息|
|管理员|平台管理员（可分为城市/学校/全局）|配置管理、功能开关、信封采纳、系统统计访问|
|系统服务（Server）|内部模块或AI子系统（如 AI回信调度服务）|访问内部接口、无用户交互界面|

---

## **三、认证机制与流程**

  

### **3.1 用户认证（JWT）**

- 注册/登录成功后颁发 JWT（有效期7天）
    
- 前端请求需携带 Authorization: Bearer <token>
    
- Token 中包含角色、有效期、绑定设备信息
    

  

### **3.2 OAuth2（拓展）**

- 支持通过微信/校园认证系统/邮箱链接授权
    
- 登录后仍颁发标准 JWT，用于前后端通信
    

  

### **3.3 信使认证**

- 信使角色自动绑定账号ID + 角色等级（messenger_1 ~ messenger_4）
    
- 所有信使操作需 Token + 额外二次验证机制（如扫码器/投递码输入）
    

  

### **3.4 后台管理员登录**

- 后台独立登录口，采用双因素认证（密码 + 验证码）
    
- 管理操作日志全部记录在操作日志系统中（见前文）
    

---

## **四、RBAC 权限设计（Role-Based Access Control）**

|**接口分类**|**可访问角色**|**备注**|
|---|---|---|
|写信、绑定条码|注册用户|匿名信也需登录后执行|
|投递任务相关接口|信使（含等级控制）|信使需有权限的 OP Code 段才可操作|
|信封审核与活动管理|管理员（城市或学校级别）|仅对应城市/学校管理员有权限|
|全局设置修改|超管 admin_root|如关闭功能模块、全局奖励额度调整等|
|AI系统调用接口|系统内部服务（server_token 认证）|不对外暴露，仅系统服务访问|

---

## **五、API Key & Server Token**

  

### **Server Token 用于：**

- 🧠 AI内容生成服务（调用 write-service）
    
- 📬 投递调度器调用 courier-service
    
- 📊 数据统计平台访问数据库聚合接口
    

  

格式：

```
Authorization: Bearer SERVER_<UUID>
```

- 可配置 IP 白名单、调用频率、单次访问范围
    
- 使用 Redis 验证并缓存 Token 权限
    

---

## **六、接口权限中间件结构**

  

中间件示意（Go 实现）：

```
func AuthMiddleware(requiredRoles []string) gin.HandlerFunc {
  return func(c *gin.Context) {
    token := extractToken(c.Request)
    claims := parseJWT(token)

    if !contains(requiredRoles, claims.Role) {
      c.AbortWithStatusJSON(http.StatusForbidden, gin.H{"error": "Access Denied"})
      return
    }

    c.Set("user_id", claims.UID)
    c.Next()
  }
}
```

---

## **七、安全机制与防护建议**

|**安全控制点**|**措施**|
|---|---|
|Token篡改|使用 RS256 非对称加密签名（不可伪造）|
|重放攻击|所有敏感操作使用 One-Time Token（如绑定条码）|
|用户信息越权访问|每次查询接口需判断 requester_id 与目标 user_id 是否一致|
|后台操作记录|所有变更操作入日志系统，不可删除或覆盖|
|Token黑名单机制|用户登出/封号等场景，JWT 进入 Redis 黑名单即时失效|

---

## **八、后续拓展**

- 📱 多端登录限制（每用户最多2个设备同时在线）
    
- 🧑‍🏫 教师/社团组织专属权限系统（用于后续进校合作）
    
- 🔐 SSO 接入（如校园系统/统一身份认证）
    

---

是否继续输出最后一个系统模块（如模块调用关系图 / 系统总体架构图）？或者汇总一下基础设施层级的全景结构？✅