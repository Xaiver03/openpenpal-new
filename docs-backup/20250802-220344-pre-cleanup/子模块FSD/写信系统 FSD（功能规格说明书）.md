## **一、功能概述**

  

写信系统是 OpenPenPal 的核心功能模块，支持用户在线创建、编辑并发送手写或电子信件。系统支持实名定向信、匿名漂流信、公开信及未来信等多种类型，并与信封、条码、编码系统深度联动，确保每封信都能被唯一识别、被准确投递。

---

## **二、主要功能列表**

|**功能模块**|**描述**|
|---|---|
|写信入口|进入写信页，选择信件类型、信纸样式、输入内容|
|条码生成与绑定|写完后生成唯一条码，用于标记与追踪该信件|
|投递方式选择|宿舍自投/商店投递/交由信使取件|
|灵感卡片推荐|写信前系统推送写作引导建议|
|写信记录中心|展示用户所有发送/接收/草稿信件|
|回信入口|收到信件后点击“回信”自动进入写信流程并预填收件人|
|公共信管理|支持公开展示 + 收藏 + 举报他人信件|
|上传手写信照片|允许用户将手写内容上传替代电子录入文字（支持OCR）|

---

## **三、用户流程图**

```
graph TD
Start[进入写信页面] --> A[选择信件类型]
A --> B[输入/上传内容]
B --> C[选择信纸样式]
C --> D[确认是否匿名]
D --> E[生成条码并下载二维码贴纸]
E --> F[提示打印或绑定到信封]
F --> G[选择投递方式]
G --> H[完成投递 / 提交信使任务]
```

---

## **四、页面结构与交互说明**

  

### **4.1 写信页（/write）**

|**元素**|**类型**|**描述**|
|---|---|---|
|信件类型选择|Tabs|匿名漂流信 / 实名定向信 / 公开信 / 未来信|
|输入区域|Rich Text / OCR|可手动输入或上传图片（系统自动识别+附加）|
|信纸样式|单选卡片|支持风格化模板选择（如怀旧、明信片、信笺）|
|签名设置|Text|支持设置“笔名”或真实署名|
|匿名选项|Toggle|是否隐藏署名和身份信息|
|未来寄达设置|Date|设置延迟投递时间（默认立即）|
|条码生成与下载|按钮 + Preview|点击生成后可预览二维码 + 下载 PDF|
|提交按钮|Button|校验完成后提交写信任务并提示投递方式|

---

## **五、接口设计（前后端）**

  

### **5.1 创建信件（POST** 

### **/api/letters**

### **）**

|**字段**|**类型**|**必填**|**描述**|
|---|---|---|---|
|type|enum|是|direct / drift-ai / drift-manual / public / future|
|content|string|是|信件文本（或 OCR 转换后）|
|image_attachment|string?|否|上传的手写图像（Base64 或 URL）|
|recipient_code|string|条件|指定 OP Code，若为定向信或公开信|
|send_time|datetime|否|未来信可设置寄送时间|
|is_anonymous|boolean|是|是否匿名|
|nickname|string|否|匿名署名|
|paper_template|string|否|选中的信纸样式 ID|

**返回值：**

```
{
  letter_id: string,
  barcode_url: string, // PDF 贴纸下载地址
  status: "pending"
}
```

---

### **5.2 获取信件详情（GET** 

### **/api/letters/:id**

### **）**

- 鉴权：仅寄信人、收信人可查看
    
- 若为公开信则所有人可查看
    

---

### **5.3 回信创建（POST** 

### **/api/letters/:id/reply**

### **）**

- 自动填入原收件人的 OP Code，支持引用前信
    

---

## **六、数据结构设计（简要）**

```
Letter {
  id: string,
  author_id: string,
  type: "direct" | "drift-ai" | "drift-manual" | "public" | "future",
  content: string,
  image_url?: string,
  recipient_code?: string,
  is_anonymous: boolean,
  nickname: string,
  paper_style: string,
  status: "draft" | "ready" | "delivered" | "expired",
  barcode_id: string,
  created_at: datetime,
  send_time: datetime
}
```

---

## **七、状态流转逻辑**

|**状态**|**触发动作**|
|---|---|
|draft|写信未提交|
|ready|已生成条码，等待绑定 & 投递|
|delivered|收信人扫码或系统确认投递完成|
|expired|条码超期未使用，作废|

---

## **八、错误处理与边界说明**

|**场景**|**处理方式**|
|---|---|
|上传图片无法识别|提示“建议清晰拍摄后重试”|
|匿名漂流未匹配成功|自动延迟重试+AI重新画像|
|条码未绑定 / 丢失|提示重新下载贴纸或生成新条码|
|超过每日写信限制（如反刷）|触发风控提示+冷却时间|

---

## **九、外部依赖接口**

|**模块**|**交互说明**|
|---|---|
|条码系统|写信成功后调用条码生成 API，返回二维码链接|
|信封系统|若用户已选择配套信封 → 绑定信封编号同步|
|编码系统|校验收件人 OP Code 是否有效|
|AI系统|匿名信可调用 AI 匹配引擎写入收件人编码|
|信使系统|若用户选择“信使投递” → 创建任务记录到信使任务池中|

---

## **十、非功能性要求**

|**类别**|**要求**|
|---|---|
|响应速度|条码生成 ≤ 1 秒，上传手写图像 ≤ 3 秒|
|数据安全|所有信件内容加密存储，非本人不可访问|
|错误容错|草稿自动保存，上传失败自动重试一次|
|合规性|禁止恶意/攻击性文本上传，接口需接入审核系统|
