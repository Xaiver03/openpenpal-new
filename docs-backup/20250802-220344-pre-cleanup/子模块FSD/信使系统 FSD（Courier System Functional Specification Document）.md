## **一、模块定位**

信使系统是 OpenPenPal 实体信件流转的执行中枢，也是社区运营与用户参与的基础单位。它承担“宿舍 → 商店/中转站 → 收件人”的全链条投递职责，同时也是信件制度与文化的落地推动者。

---

## **二、信使等级体系**

|**等级**|**管辖范围**|**权限与职责**|
|---|---|---|
|四级信使（城市）|城市维度|新学校开通、城市级信封发布、前两位 postcode 管理|
|三级信使（学校）|所在学校|校内片区投递调度、信封设计征集、信使管理、3-4位 postcode 管理|
|二级信使（片区）|宿舍楼/片区|派送任务分发、点位审核与维护、信件中转|
|一级信使（楼栋）|宿舍或商店|执行投递任务、扫码更新状态、直接与用户接触|

---

## **三、主要功能模块**

|**模块**|**描述**|
|---|---|
|信使注册与审核|用户可申请成为各级信使，需由上级审核|
|任务中心|一级信使领取、提交和更新投递任务|
|点位管理|二级信使审批宿舍/商店投递点，管理可投地址池|
|成长体系|信使完成任务获得积分 → 升级等级、获得徽章或奖励|
|排班与调度|三级/四级信使可配置定期投递时间、临时替班安排|
|通知与沟通系统|自动生成任务通知，可添加留言、用户备注等信息|
|异常与举报|信件遗失、破损、违规信件可由信使上报平台处理|

---

## **四、流程图：信件从生成到送达**

```
sequenceDiagram
用户 ->> 写信系统: 创建信件并生成条码
用户 -->> 投递点: 放入实体信封
投递点 -->> 一级信使: 收取并扫码
一级信使 ->> 二级信使: 上报完成
二级信使 ->> 信使中心: 更新任务状态
信件流转 ->> 收件人: 扫码查看并确认收件
```

---

## **五、信使端页面/功能说明**

### **5.1 信使中心主页（/courier/home）**

|**功能**|**描述**|
|---|---|
|我的任务|显示待领取、待派送、已完成信件清单|
|状态更新入口|可扫码或手动录入条码编号更新状态|
|任务积分与记录|展示每条任务积分、累计任务数、成长等级|
|通知栏|上级通知、异常反馈、群体广播等|

---

### **5.2 点位管理（/courier/points）**

|**功能**|**描述**|
|---|---|
|点位申请审核|二级信使审核新增宿舍/商店为可投递点|
|编码维护|自动分配/释放 postcode 后两位编码段|
|地址地图展示|可视化展示全校可投递区域与点位密度|

---

## **六、接口设计**

### **6.1 信使申请（POST**

### **/api/couriers/apply**

### **）**

|**字段**|**类型**|**描述**|
|---|---|---|
|user_id|string|申请人 ID|
|level|enum|level1 / level2 / level3 / level4|
|target_code|string|所管理的 postcode 编码段|
|reason|string|申请理由|

---

### **6.2 获取任务（GET**

### **/api/couriers/tasks?status=pending**

### **）**

返回该信使当前待处理任务，按时间与区域优先级排序。

---

### **6.3 扫码更新状态（PATCH**

### **/api/couriers/update-status**

### **）**

|**字段**|**类型**|**描述**|
|---|---|---|
|barcode_id|string|信件条码编号|
|status|enum|picked / in_transit / delivered|
|location|string|当前扫码地点|
|operator|string|信使 user_id|

---

## **七、数据结构（简要）**

```
Courier {
  id: string,
  user_id: string,
  level: "1" | "2" | "3" | "4",
  managed_codes: string[],
  points: number,
  badges: string[],
  approved: boolean,
  joined_at: datetime
}

CourierTask {
  id: string,
  barcode_id: string,
  from_code: string,
  to_code: string,
  assigned_to: string,
  status: "pending" | "in_progress" | "done",
  updated_at: datetime
}
```

---

## **八、状态流转逻辑**

|**状态**|**描述**|
|---|---|
|pending|信件投递任务已生成，尚未领取|
|in_progress|一级信使领取任务后开始投递|
|done|用户扫码确认收件或终端信使标记完成|
|failed|信件无法投递或被举报，进入异常处理流程|

---

## **九、安全与风控机制**

|**风控机制**|**描述**|
|---|---|
|信件溯源日志|每条信件投递记录完整存档，包括时间、地点、扫码人|
|信使权限控制|仅对应 postcode 段内的信件可被操作|
|异常上报渠道|平台/收件人可匿名举报信使操作失误或违规行为|
|审批防刷限制|每人同周期申请成为信使次数有限（如每30天仅一次）|
|任务重分配机制|超时未处理任务可由上级信使或系统调度给他人|

---

## **十、与其他系统接口关系**

|**模块**|**描述**|
|---|---|
|条码系统|信使通过扫码操作更新条码状态|
|编码系统|信使权限根据 postcode 段进行授权管理|
|写信系统|写信完成后若选择“信使派送” → 自动生成任务|
|信封系统|投递任务仅允许配送平台指定信封（防伪校验）|
|通知系统|任务提醒、投递超时、系统广播由平台发送给信使|
