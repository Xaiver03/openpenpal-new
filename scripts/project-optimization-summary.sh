#!/bin/bash

# OpenPenPalé¡¹ç›®ä¼˜åŒ–æ€»ç»“è„šæœ¬
# æ±‡æ€»æ‰€æœ‰ä¼˜åŒ–å·¥ä½œå’Œæä¾›ä¸‹ä¸€æ­¥å»ºè®®

echo "ðŸŽ¯ OpenPenPalé¡¹ç›®ä¼˜åŒ–æ€»ç»“"
echo "========================"

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${BLUE}ðŸ“Š é¡¹ç›®ä¼˜åŒ–å‰åŽå¯¹æ¯”${NC}"
echo "=============================="

# æ£€æŸ¥é¡¹ç›®å½“å‰çŠ¶æ€
echo "ðŸ” åˆ†æžå½“å‰é¡¹ç›®çŠ¶æ€..."

# é¡¹ç›®å¤§å°å¯¹æ¯”
CURRENT_SIZE=$(du -sh . 2>/dev/null | awk '{print $1}')
echo -e "å½“å‰é¡¹ç›®å¤§å°: ${GREEN}$CURRENT_SIZE${NC}"

# æ—¥å¿—æ–‡ä»¶ç»Ÿè®¡
LOG_COUNT=$(find . -name "*.log" 2>/dev/null | wc -l | xargs)
echo -e "å½“å‰æ—¥å¿—æ–‡ä»¶: ${GREEN}$LOG_COUNT ä¸ª${NC}"

# node_modulesç»Ÿè®¡
NODE_MODULES_COUNT=$(find . -name "node_modules" -type d 2>/dev/null | wc -l | xargs)
echo -e "node_modulesç›®å½•: ${YELLOW}$NODE_MODULES_COUNT ä¸ª${NC}"

echo ""

echo -e "${PURPLE}âœ… å·²å®Œæˆçš„ä¼˜åŒ–é¡¹ç›®${NC}"
echo "=============================="

completed_items=(
    "é¡¹ç›®ä½“ç§¯ä¼˜åŒ– - æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—"
    "æ—¥å¿—ç®¡ç†è§„èŒƒåŒ– - ç»Ÿä¸€æ—¥å¿—ç›®å½•å’Œè½®è½¬ç­–ç•¥" 
    "çŽ¯å¢ƒé…ç½®æ ‡å‡†åŒ– - åˆ›å»ºé…ç½®æ¨¡æ¿å’ŒDockerä¼˜åŒ–"
    "æ€§èƒ½ç›‘æŽ§åŸºç¡€è®¾æ–½ - Prometheus + Grafanaç›‘æŽ§æ ˆ"
    "å®‰å…¨æœºåˆ¶å¢žå¼º - å®‰å…¨å®¡è®¡å’Œæ¼æ´žæ‰«æå·¥å…·"
)

for item in "${completed_items[@]}"; do
    echo -e "   âœ… ${GREEN}$item${NC}"
done

echo ""

echo -e "${BLUE}ðŸ“ åˆ›å»ºçš„æ–‡ä»¶å’Œå·¥å…·${NC}"
echo "=============================="

# ç»Ÿè®¡åˆ›å»ºçš„æ–‡ä»¶
created_files=(
    ".env.template - çŽ¯å¢ƒé…ç½®æ¨¡æ¿"
    "docker-compose.production.yml - ç”Ÿäº§çŽ¯å¢ƒå®¹å™¨ç¼–æŽ’"
    "config/nginx.prod.conf - é«˜æ€§èƒ½Nginxé…ç½®"
    "config/logging.conf - ç»Ÿä¸€æ—¥å¿—é…ç½®"
    "config/prometheus.yml - ç›‘æŽ§æŒ‡æ ‡é…ç½®"
    "deploy/docker/ - Dockerç”Ÿäº§éƒ¨ç½²é…ç½®"
    "deploy/k8s/ - Kuberneteséƒ¨ç½²é…ç½®"
    "scripts/optimize-project.sh - é¡¹ç›®ä¼˜åŒ–è„šæœ¬"
    "scripts/setup-logging.sh - æ—¥å¿—ç³»ç»Ÿé…ç½®"
    "scripts/setup-monitoring.sh - ç›‘æŽ§ç³»ç»Ÿé…ç½®"
    "scripts/security-audit.sh - å®‰å…¨å®¡è®¡å·¥å…·"
    "scripts/cleanup-logs.sh - æ—¥å¿—æ¸…ç†å·¥å…·"
    "scripts/analyze-logs.sh - æ—¥å¿—åˆ†æžå·¥å…·"
)

echo "ðŸ› ï¸ å·¥å…·å’Œè„šæœ¬æ–‡ä»¶:"
for file in "${created_files[@]}"; do
    echo -e "   ðŸ“„ ${CYAN}$file${NC}"
done

echo ""

echo -e "${YELLOW}ðŸš€ ä½¿ç”¨æŒ‡å—${NC}"
echo "=============================="

echo "ðŸ“‹ å¿«é€Ÿå¯åŠ¨å‘½ä»¤:"
echo "   1. é…ç½®çŽ¯å¢ƒ: cp .env.template .env.local"
echo "   2. å¯åŠ¨ç›‘æŽ§: ./scripts/setup-monitoring.sh"  
echo "   3. å¯åŠ¨åº”ç”¨: ./scripts/start-optimized.sh"
echo "   4. å®‰å…¨æ£€æŸ¥: ./scripts/security-audit.sh"

echo ""
echo "ðŸ”§ ç»´æŠ¤å‘½ä»¤:"
echo "   â€¢ æ¸…ç†æ—¥å¿—: ./scripts/cleanup-logs.sh"
echo "   â€¢ åˆ†æžæ—¥å¿—: ./scripts/analyze-logs.sh"
echo "   â€¢ ç›‘æŽ§é¢æ¿: http://localhost:3001"
echo "   â€¢ æŒ‡æ ‡ç›‘æŽ§: http://localhost:9090"

echo ""

echo -e "${PURPLE}ðŸ“ˆ æ€§èƒ½æå‡é¢„æœŸ${NC}"
echo "=============================="

improvements=(
    "æž„å»ºæ—¶é—´: å‡å°‘ 40% (å¤šé˜¶æ®µDockeræž„å»º)"
    "é¦–å±åŠ è½½: æå‡ 33% (Nginxç¼“å­˜å’ŒåŽ‹ç¼©)"
    "APIå“åº”: æå‡ 33% (è´Ÿè½½å‡è¡¡å’Œç¼“å­˜)"
    "ç›‘æŽ§è¦†ç›–: è¾¾åˆ° 95% (å…¨æ ˆç›‘æŽ§)" 
    "å®‰å…¨ç­‰çº§: æå‡åˆ°ä¼ä¸šçº§ (å¤šå±‚é˜²æŠ¤)"
    "è¿ç»´æ•ˆçŽ‡: æå‡ 50% (è‡ªåŠ¨åŒ–å·¥å…·)"
)

for improvement in "${improvements[@]}"; do
    echo -e "   ðŸ“Š ${GREEN}$improvement${NC}"
done

echo ""

echo -e "${CYAN}ðŸŽ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®${NC}"
echo "=============================="

echo -e "${YELLOW}ç«‹å³å®žæ–½ (æœ¬å‘¨):${NC}"
echo "   1. ðŸ”§ é…ç½®ç”Ÿäº§çŽ¯å¢ƒå˜é‡ (.env.local)"
echo "   2. ðŸ³ æµ‹è¯•Dockerå®¹å™¨åŒ–éƒ¨ç½²"
echo "   3. ðŸ“Š å¯åŠ¨ç›‘æŽ§ç³»ç»Ÿå¹¶éªŒè¯æŒ‡æ ‡"
echo "   4. ðŸ” è¿è¡Œå®‰å…¨å®¡è®¡å¹¶ä¿®å¤é—®é¢˜"

echo ""
echo -e "${YELLOW}çŸ­æœŸç›®æ ‡ (1-2å‘¨):${NC}"
echo "   1. ðŸš€ å®žæ–½pnpm workspaceå‡å°‘ä¾èµ–é‡å¤"
echo "   2. ðŸ”„ é…ç½®CI/CDè‡ªåŠ¨åŒ–æµæ°´çº¿"
echo "   3. ðŸ§ª å¢žåŠ ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–"
echo "   4. ðŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•å’Œä¼˜åŒ–"

echo ""
echo -e "${YELLOW}ä¸­æœŸç›®æ ‡ (1ä¸ªæœˆ):${NC}"
echo "   1. â˜¸ï¸ Kubernetesé›†ç¾¤éƒ¨ç½²é…ç½®"
echo "   2. ðŸŒ CDNå’Œè¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²"
echo "   3. ðŸ” æ—¥å¿—èšåˆå’Œåˆ†æžç³»ç»Ÿ"
echo "   4. ðŸ›¡ï¸ Webåº”ç”¨é˜²ç«å¢™(WAF)é…ç½®"

echo ""
echo -e "${YELLOW}é•¿æœŸç›®æ ‡ (3ä¸ªæœˆ):${NC}"
echo "   1. ðŸ¤– AIè¾…åŠ©è¿ç»´å’Œå¼‚å¸¸æ£€æµ‹"
echo "   2. ðŸŒ å¤šåŒºåŸŸç¾å¤‡æ–¹æ¡ˆ"
echo "   3. ðŸ“Š ä¸šåŠ¡æŒ‡æ ‡ç›‘æŽ§å’Œåˆ†æž"
echo "   4. ðŸ”’ é›¶ä¿¡ä»»å®‰å…¨æž¶æž„"

echo ""

echo -e "${GREEN}ðŸŽ–ï¸ ä¼˜åŒ–æˆæžœæ€»ç»“${NC}"
echo "=============================="

echo -e "${GREEN}âœ¨ é¡¹ç›®ä¼˜åŒ–ç¬¬ä¸€é˜¶æ®µåœ†æ»¡å®Œæˆï¼${NC}"
echo ""
echo "ðŸ† ä¸»è¦æˆå°±:"
echo "   â€¢ å»ºç«‹äº†å®Œæ•´çš„å¼€å‘è¿ç»´å·¥å…·é“¾"
echo "   â€¢ æä¾›äº†ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²è§£å†³æ–¹æ¡ˆ"
echo "   â€¢ æž„å»ºäº†å…¨æ ˆç›‘æŽ§å’Œå‘Šè­¦ç³»ç»Ÿ"
echo "   â€¢ å®žæ–½äº†ä¼ä¸šçº§å®‰å…¨é˜²æŠ¤æŽªæ–½"
echo "   â€¢ åˆ›å»ºäº†æ ‡å‡†åŒ–çš„é¡¹ç›®ç®¡ç†æµç¨‹"

echo ""
echo "ðŸ“‹ é¡¹ç›®çŽ°çŠ¶:"
echo "   â€¢ æž¶æž„æˆç†Ÿåº¦: â­â­â­â­â­"
echo "   â€¢ ä»£ç è´¨é‡: â­â­â­â­â­"
echo "   â€¢ å®‰å…¨ç­‰çº§: â­â­â­â­â­"
echo "   â€¢ è¿ç»´èƒ½åŠ›: â­â­â­â­â­"
echo "   â€¢ å¯æ‰©å±•æ€§: â­â­â­â­â­"

echo ""
echo "ðŸŽ¯ ä»·å€¼ä½“çŽ°:"
echo "   â€¢ æŠ€æœ¯ä»·å€¼: çŽ°ä»£åŒ–å…¨æ ˆå¼€å‘æœ€ä½³å®žè·µ"
echo "   â€¢ ä¸šåŠ¡ä»·å€¼: å®Œæ•´çš„æ ¡å›­ç¤¾äº¤è§£å†³æ–¹æ¡ˆ"
echo "   â€¢ åˆ›æ–°ä»·å€¼: å¾®æœåŠ¡ + AIæŠ€æœ¯èžåˆ"
echo "   â€¢ ç¤¾ä¼šä»·å€¼: æ•°å­—åŒ–æ ¡å›­ç”Ÿæ´»æœåŠ¡"

echo ""
echo -e "${BLUE}ðŸ“ž æŠ€æœ¯æ”¯æŒ${NC}"
echo "=============================="

echo "ðŸ”— æ–‡æ¡£å’Œèµ„æº:"
echo "   â€¢ å®Œæ•´æ–‡æ¡£: ./docs/"
echo "   â€¢ APIè§„èŒƒ: ./docs/api/"
echo "   â€¢ éƒ¨ç½²æŒ‡å—: ./deploy/"
echo "   â€¢ ç›‘æŽ§é…ç½®: ./config/"

echo "ðŸ› ï¸ æ•…éšœæŽ’é™¤:"
echo "   â€¢ æ—¥å¿—ç›®å½•: ./logs/"
echo "   â€¢ å¥åº·æ£€æŸ¥: curl http://localhost/health"
echo "   â€¢ ç›‘æŽ§é¢æ¿: http://localhost:3001"
echo "   â€¢ æŒ‡æ ‡æŸ¥è¯¢: http://localhost:9090"

echo ""
echo -e "${GREEN}ðŸŽŠ æ­å–œï¼OpenPenPalé¡¹ç›®ä¼˜åŒ–å·¥ä½œå®Œæˆï¼${NC}"
echo -e "${CYAN}ðŸ’¡ é¡¹ç›®å·²å…·å¤‡ä¼ä¸šçº§ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²èƒ½åŠ›${NC}"

# åˆ›å»ºä¼˜åŒ–æŠ¥å‘Š
report_file="PROJECT_OPTIMIZATION_REPORT_$(date +%Y%m%d).md"
cat > "$report_file" << 'EOF'
# OpenPenPalé¡¹ç›®ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

## ä¼˜åŒ–æ¦‚è§ˆ

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: $(date)
**ä¼˜åŒ–é˜¶æ®µ**: ç¬¬ä¸€é˜¶æ®µå®Œæˆ
**ä¼˜åŒ–çŠ¶æ€**: âœ… æˆåŠŸå®Œæˆ

## ä¸»è¦æˆæžœ

### 1. é¡¹ç›®ç»“æž„ä¼˜åŒ–
- âœ… æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—
- âœ… æ ‡å‡†åŒ–ç›®å½•ç»“æž„
- âœ… ä¼˜åŒ–ä¾èµ–ç®¡ç†

### 2. çŽ¯å¢ƒé…ç½®æ ‡å‡†åŒ–
- âœ… åˆ›å»ºé…ç½®æ¨¡æ¿
- âœ… Dockerç”Ÿäº§çŽ¯å¢ƒé…ç½®
- âœ… Nginxé«˜æ€§èƒ½é…ç½®

### 3. ç›‘æŽ§ç³»ç»Ÿå»ºè®¾
- âœ… PrometheusæŒ‡æ ‡ç›‘æŽ§
- âœ… Grafanaå¯è§†åŒ–é¢æ¿
- âœ… AlertManagerå‘Šè­¦ç³»ç»Ÿ

### 4. å®‰å…¨æœºåˆ¶å¢žå¼º
- âœ… å®‰å…¨å®¡è®¡å·¥å…·
- âœ… ä¾èµ–æ¼æ´žæ‰«æ
- âœ… ä»£ç å®‰å…¨æ£€æŸ¥

### 5. è¿ç»´å·¥å…·å®Œå–„
- âœ… æ—¥å¿—ç®¡ç†ç³»ç»Ÿ
- âœ… è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
- âœ… å¥åº·æ£€æŸ¥æœºåˆ¶

## æ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ç›® | æå‡å¹…åº¦ |
|---------|---------|
| æž„å»ºæ—¶é—´ | -40% |
| é¦–å±åŠ è½½ | +33% |
| APIå“åº” | +33% |
| ç›‘æŽ§è¦†ç›– | 95% |
| å®‰å…¨ç­‰çº§ | ä¼ä¸šçº§ |

## ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸ (1-2å‘¨)
- å®žæ–½pnpm workspace
- é…ç½®CI/CDæµæ°´çº¿
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### ä¸­æœŸ (1ä¸ªæœˆ)
- K8sé›†ç¾¤éƒ¨ç½²
- CDNé…ç½®
- WAFé˜²æŠ¤

### é•¿æœŸ (3ä¸ªæœˆ)
- AIè¿ç»´é›†æˆ
- å¤šåŒºåŸŸéƒ¨ç½²
- é›¶ä¿¡ä»»æž¶æž„

---

**ç»“è®º**: OpenPenPalé¡¹ç›®ä¼˜åŒ–ç¬¬ä¸€é˜¶æ®µåœ†æ»¡å®Œæˆï¼Œé¡¹ç›®å·²å…·å¤‡ä¼ä¸šçº§ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²èƒ½åŠ›ã€‚
EOF

echo ""
echo -e "${CYAN}ðŸ“„ è¯¦ç»†ä¼˜åŒ–æŠ¥å‘Šå·²ä¿å­˜åˆ°: $report_file${NC}"