# 上线前检查清单

## 基本信息
- **版本号**: _______________
- **提交SHA**: _______________
- **计划上线时间**: _______________
- **回滚计划**: _______________

## 🔧 环境与配置

### 环境变量校验
- [ ] 运行 `./scripts/deployment/validate-env.js` 通过
- [ ] 生产环境变量已配置且安全
- [ ] 密钥强度符合要求（至少32字符）
- [ ] API密钥有效且已测试

### 机密安全
- [ ] 前端代码中无敏感信息
- [ ] 只有 `NEXT_PUBLIC_` 前缀变量暴露到前端
- [ ] JWT密钥已轮换（如需要）
- [ ] 数据库密码符合复杂度要求

## 🗄️ 数据库与缓存

### 数据库迁移
- [ ] 运行 `./scripts/deployment/db-migrate.sh up` 成功
- [ ] 迁移可重复执行（幂等性）
- [ ] 破坏性变更采用 expand-contract 模式
- [ ] 回滚脚本已测试 `./scripts/deployment/db-migrate.sh down`

### 数据安全
- [ ] 生产数据已备份 `./scripts/deployment/db-migrate.sh backup`
- [ ] 备份恢复已验证
- [ ] 慢查询已优化，执行计划合理
- [ ] 索引策略已确认

### 缓存策略
- [ ] Redis配置正确
- [ ] 缓存键命名规范
- [ ] TTL设置合理
- [ ] 缓存穿透保护已启用

## 🏗️ 构建与镜像

### 前端构建
- [ ] `npm run build` 成功
- [ ] TypeScript类型检查通过 `npm run type-check`
- [ ] ESLint检查通过 `npm run lint`
- [ ] 打包体积报告正常（< 5MB）
- [ ] 路由清单确认无误

### 后端构建
- [ ] Go编译成功 `go build -trimpath`
- [ ] 二进制包含版本信息
- [ ] 静态代码分析通过 `golangci-lint run`
- [ ] 二进制大小合理（< 50MB）

### Docker镜像
- [ ] 前端镜像构建成功 `docker build frontend/`
- [ ] 后端镜像构建成功 `docker build backend/`
- [ ] 镜像标签包含git SHA和构建时间
- [ ] 使用非root用户运行
- [ ] 多阶段构建减少镜像大小

## 🧪 测试与验证

### 单元测试
- [ ] 前端单元测试通过 `npm run test:ci`
- [ ] 后端单元测试通过 `go test ./... -race`
- [ ] 测试覆盖率达到基线（> 70%）
- [ ] 无竞态条件

### 集成测试
- [ ] API合同测试通过 `dredd openapi.yaml`
- [ ] 数据库连接测试通过
- [ ] Redis连接测试通过
- [ ] WebSocket连接测试通过

### 端到端测试
- [ ] 关键用户路径测试通过 `npm run test:e2e`
- [ ] 登录/注册流程正常
- [ ] 信件创建/投递流程正常
- [ ] 信使系统功能正常
- [ ] 支付流程正常（如适用）

### 性能测试
- [ ] k6压力测试通过 `k6 run k6/smoke.js`
- [ ] API响应时间P95 < 500ms
- [ ] 数据库查询时间合理
- [ ] 内存使用稳定
- [ ] 错误率 < 0.1%

## 🔒 安全与合规

### 依赖安全
- [ ] 前端依赖扫描无高危 `npm audit`
- [ ] 后端依赖扫描无高危 `nancy sleuth`
- [ ] Docker镜像扫描无高危 `trivy image`
- [ ] 许可证合规检查通过

### 基础安全测试
- [ ] SQL注入测试通过
- [ ] XSS防护测试通过
- [ ] CSRF防护测试通过
- [ ] 认证授权测试通过
- [ ] 敏感信息泄露检查通过

### 数据保护
- [ ] 个人信息加密存储
- [ ] 敏感API需要认证
- [ ] 权限控制正确实现
- [ ] 审计日志完整

## 📊 可观测性

### 健康检查
- [ ] `/healthz` 端点响应正常
- [ ] `/readyz` 端点包含依赖检查
- [ ] 健康检查包含关键依赖状态

### 日志系统
- [ ] 结构化日志格式正确
- [ ] 日志级别设置合理
- [ ] 包含 request_id 追踪
- [ ] 敏感信息已脱敏
- [ ] 日志轮转配置正确

### 监控指标
- [ ] RED指标（Rate, Errors, Duration）已配置
- [ ] USE指标（Utilization, Saturation, Errors）已配置
- [ ] 业务指标已定义
- [ ] 告警阈值已设置

### 分布式追踪
- [ ] Jaeger追踪配置正确
- [ ] 关键服务调用可追踪
- [ ] 错误链路可定位

## 🚀 部署与回滚

### 部署准备
- [ ] 部署脚本已测试
- [ ] 配置文件版本对应
- [ ] 静态资源CDN已同步
- [ ] 数据库连接池配置合理

### 蓝绿/金丝雀部署
- [ ] 新版本健康检查通过
- [ ] 流量切换策略已确认
- [ ] 回滚触发条件已定义
- [ ] 自动回滚机制已测试

### 回滚方案
- [ ] 应用回滚步骤明确
- [ ] 数据回滚方案可行
- [ ] 回滚时间评估合理
- [ ] 回滚测试已完成

## 📋 文档与值班

### 发布文档
- [ ] 变更日志已更新
- [ ] 数据迁移影响说明
- [ ] 新功能使用文档
- [ ] API文档已同步

### 应急准备
- [ ] 值班人员已确认
- [ ] 应急联系方式更新
- [ ] 故障处理手册准备
- [ ] 监控大盘已配置

### 通知计划
- [ ] 用户通知邮件准备
- [ ] 内部团队通知
- [ ] 维护窗口公告
- [ ] 客服FAQ更新

## ✅ 最终确认

### Go/No-Go评审
- [ ] 技术负责人签字: _______________
- [ ] 产品负责人签字: _______________
- [ ] 运维负责人签字: _______________
- [ ] 安全负责人签字: _______________

### 发布决策
- [ ] 所有检查项均为绿灯
- [ ] 风险评估可接受
- [ ] 回滚方案已确认
- [ ] 团队准备就绪

---

**检查完成时间**: _______________  
**检查人员**: _______________  
**最终决定**: [ ] Go [ ] No-Go  
**备注**: _______________

## 快速执行脚本

```bash
# 1. 环境检查
./scripts/deployment/validate-env.js

# 2. 构建验证
./scripts/deployment/build-verify.sh

# 3. 数据库迁移测试
./scripts/deployment/db-migrate.sh up

# 4. 本地联调测试
./scripts/deployment/local-dev.sh --skip-tests

# 5. 完整测试
./scripts/deployment/local-dev.sh

# 6. 停止测试环境
./scripts/deployment/local-dev.sh stop
```

## 常见问题排查

### 构建失败
1. 检查Node.js/Go版本是否匹配
2. 清理依赖缓存重新安装
3. 检查TypeScript类型错误
4. 查看详细构建日志

### 测试失败
1. 检查测试数据库连接
2. 确认Redis服务状态
3. 检查端口占用情况
4. 查看测试详细日志

### 部署失败
1. 检查Docker镜像可用性
2. 确认环境变量配置
3. 检查网络连通性
4. 查看容器启动日志

---

*此检查清单确保每次发布都经过严格验证，降低生产环境风险。*