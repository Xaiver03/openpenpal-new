# OpenPenPal AlertManager é…ç½®
# å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥é…ç½®

global:
  # SMTP é…ç½®
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@openpenpal.com'
  smtp_auth_username: 'alerts@openpenpal.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Slack é…ç½®
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    # ä¸¥é‡å‘Šè­¦ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m

    # æ•°æ®åº“ç›¸å…³å‘Šè­¦
    - match_re:
        alertname: PostgreSQL.*|Redis.*
      receiver: 'database-team'

    # åº”ç”¨ç¨‹åºå‘Šè­¦
    - match_re:
        job: frontend|backend|.*-service
      receiver: 'dev-team'

    # ç³»ç»Ÿèµ„æºå‘Šè­¦
    - match_re:
        alertname: High.*Usage|.*SpaceLow
      receiver: 'ops-team'

    # ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
    - match_re:
        alertname: Abnormal.*|High.*FailureRate
      receiver: 'business-team'

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    email_configs:
      - to: 'devops@openpenpal.com'
        subject: '[OpenPenPal] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          å®ä¾‹: {{ .Labels.instance }}
          æœåŠ¡: {{ .Labels.job }}
          {{ end }}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'critical@openpenpal.com,cto@openpenpal.com'
        subject: '[CRITICAL] OpenPenPal ä¸¥é‡å‘Šè­¦'
        body: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦ ğŸš¨
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          å®ä¾‹: {{ .Labels.instance }}
          æœåŠ¡: {{ .Labels.job }}
          ä¸¥é‡çº§åˆ«: {{ .Labels.severity }}
          {{ end }}
          
          è¯·ç«‹å³å¤„ç†!
    slack_configs:
      - channel: '#critical-alerts'
        title: 'ğŸš¨ OpenPenPal ä¸¥é‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          *å®ä¾‹*: {{ .Labels.instance }}
          *æœåŠ¡*: {{ .Labels.job }}
          {{ end }}
        send_resolved: true

  # æ•°æ®åº“å›¢é˜Ÿ
  - name: 'database-team'
    email_configs:
      - to: 'dba@openpenpal.com,backend@openpenpal.com'
        subject: '[DB] OpenPenPal æ•°æ®åº“å‘Šè­¦'
        body: |
          æ•°æ®åº“å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          æ•°æ®åº“: {{ .Labels.instance }}
          {{ end }}
    slack_configs:
      - channel: '#database-alerts'
        title: 'ğŸ“Š æ•°æ®åº“å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # å¼€å‘å›¢é˜Ÿ
  - name: 'dev-team'
    email_configs:
      - to: 'dev@openpenpal.com'
        subject: '[DEV] OpenPenPal åº”ç”¨å‘Šè­¦'
        body: |
          åº”ç”¨æœåŠ¡å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          æœåŠ¡: {{ .Labels.job }}
          å®ä¾‹: {{ .Labels.instance }}
          {{ end }}
    slack_configs:
      - channel: '#dev-alerts'
        title: 'ğŸ’» åº”ç”¨æœåŠ¡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *æœåŠ¡*: {{ .Labels.job }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

  # è¿ç»´å›¢é˜Ÿ
  - name: 'ops-team'
    email_configs:
      - to: 'ops@openpenpal.com'
        subject: '[OPS] OpenPenPal ç³»ç»Ÿèµ„æºå‘Šè­¦'
        body: |
          ç³»ç»Ÿèµ„æºå‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ä¸»æœº: {{ .Labels.instance }}
          {{ end }}
    slack_configs:
      - channel: '#ops-alerts'
        title: 'ğŸ–¥ï¸ ç³»ç»Ÿèµ„æºå‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *ä¸»æœº*: {{ .Labels.instance }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *å½“å‰å€¼*: {{ .Annotations.description }}
          {{ end }}

  # ä¸šåŠ¡å›¢é˜Ÿ
  - name: 'business-team'
    email_configs:
      - to: 'business@openpenpal.com,product@openpenpal.com'
        subject: '[BUSINESS] OpenPenPal ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦'
        body: |
          ä¸šåŠ¡æŒ‡æ ‡å¼‚å¸¸å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          è¯·æ£€æŸ¥ä¸šåŠ¡æ•°æ®å’Œç”¨æˆ·è¡Œä¸ºï¼
    slack_configs:
      - channel: '#business-alerts'
        title: 'ğŸ“ˆ ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *æŒ‡æ ‡*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

# æŠ‘åˆ¶è§„åˆ™ - é¿å…é‡å¤å‘Šè­¦
inhibit_rules:
  # å¦‚æœæœåŠ¡å®•æœºï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: ServiceDown
    target_match_re:
      alertname: High.*|.*Slow.*
    equal: ['instance']

  # å¦‚æœæœ‰ä¸¥é‡å†…å­˜å‘Šè­¦ï¼ŒæŠ‘åˆ¶CPUå‘Šè­¦
  - source_match:
      alertname: HighMemoryUsage
      severity: critical
    target_match:
      alertname: HighCPUUsage
    equal: ['instance']

  # å¦‚æœæœ‰æ•°æ®åº“è¿æ¥é—®é¢˜ï¼ŒæŠ‘åˆ¶åº”ç”¨é”™è¯¯å‘Šè­¦
  - source_match_re:
      alertname: PostgreSQL.*|Redis.*
    target_match:
      alertname: HighHTTPErrorRate
    equal: ['job']