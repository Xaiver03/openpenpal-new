## **一、模块定位**

OpenPenPal 的 AI 子系统致力于在不破坏平台“真实温度感”的前提下，为用户提供“灵感生成 + 情绪共鸣 + 内容中转 + 社交辅助”的温柔支持。它不承担主体内容创作职能，而是以“写作助理”和“情绪共鸣者”的身份嵌入写信流程与信件生态。

---

## **二、核心目标**

|**目标**|**描述**|
|---|---|
|不破坏人文气息|拒绝自动生成完整信件；始终强调“人写给人”的信件本质|
|降低写信门槛|为用户提供“灵感卡片”“信纸引导”“格式模板”等|
|丰富信件流转形式|支持漂流信 AI 匹配、AI 笔友模拟等交互方式|
|提升内容组织与展览能力|AI 参与信件主题策展、信件博物馆归类与展示|
|保持慢节奏与仪式感|所有 AI 行为具备延时或等待机制，不打破用户的耐心回路|

---

## **三、功能模块**

### **3.1 自由笔友匹配（AI内容画像引导匹配）**

|**功能说明**|
|---|
|用户写匿名信并选择“漂流信 → AI匹配”后，平台提取关键信息（如情绪、主题、写作风格）|
|系统根据内容计算“语义共鸣度”，匹配当前系统中最契合的收件人编码|
|匹配完成后自动将该编码绑定至该信条码（不公开收件人姓名）|

### **3.2 云中锦书（长期AI笔友伙伴）**

|**功能说明**|
|---|
|用户选择一个长期陪伴的AI笔友人设（如"诗人""哲学家""朋友"等）|
|建立持续的书信往来关系，AI保持一致的性格和记忆|
|发出一封信 → AI根据角色设定和历史对话在24小时内"回信"|
|所有通信保存于"云中锦书"专区，支持长期情感陪伴和成长记录|

### **3.3 角色驿站（回信角度建议）**

|**功能说明**|
|---|
|基于不同角色视角（朋友、长辈、同学等）为用户的回信提供思路和建议|
|AI提供回信角度和要点，而非直接生成完整内容，保持回信的原创性|
|支持创建个性化角色，根据特定关系和场景定制回信建议|
|帮助理解来信的情感需求，提供合适的回应策略和语气建议|

### **3.4 写作灵感卡片（写作引导）**

|**类型**|**示例**|
|---|---|
|时间型|“今天是7月26日，去年此时你在做什么？”|
|情感型|“用一封信，把你不敢当面说的那句话写出来”|
|角色型|“假如你是树洞，可以接住谁的秘密？”|
|话题联想型|“看到‘毕业’这个词，你脑海里第一个画面是？”|

> 灵感卡片可作为进入写信页面的“起始建议卡片”，提升打开率与内容质量

### **3.5 信件博物馆策展助手**

|**功能说明**|
|---|
|用户将已公开的信件授权提交至“信件博物馆”|
|AI 将其按主题（如“未寄出的信”“毕业季”“写给陌生人”等）归类并命名展区|
|展示效果由 AI 决定顺序、摘录语句、策展文案，形成“AI协同下的人类情感博物馆”|

---

## **四、节奏控制机制（慢节奏策略）**

|**模块**|**限制机制说明**|
|---|---|
|AI匹配寄信|匹配过程需等待1小时以内，模拟“漂流”不确定性|
|云中锦书回信|首封回信需延迟至少8小时；后续每次通信需间隔24小时|
|灵感卡片更新|每日推送不超过2条，避免打断真实情绪生成|
|AI展示推荐|不主动推送 AI 内容，仅在用户主动进入或完成动作后展示|

---

## **五、用户界面（UI建议）**

|**场景**|**AI功能入口**|
|---|---|
|写信页面上方|显示灵感卡片模块（最多1张/天）|
|信件完成后页面|弹出"是否选择 AI匹配寄信"或"写信给云中锦书"|
|回信页面|提供"角色驿站"入口，获取不同角色视角的回信建议|
|公开信查看页面|展示“博物馆策展：本信件被收录于【___】”|

---

## **六、数据结构（简要）**

```
AIMatchRecord {
  match_id: string,
  letter_id: string,
  semantic_profile: string[],
  matched_code: string,
  strategy: "emotion-first" | "topic-first",
  timestamp: datetime
}

AIPenpalMessage {
  user_id: string,
  penpal_theme: string,
  messages: [
    { role: "user", content: string },
    { role: "ai", content: string, delay_ms: number }
  ],
  created_at: datetime
}
```

---

## **七、安全性与边界设置**

|**项目**|**限制说明**|
|---|---|
|内容生成限制|AI不得生成带有真实姓名、联系信息、内容过长或攻击性表达的信件内容|
|数据收集策略|匿名信件仅在用户授权下参与AI画像/训练|
|决策不可逆限制|AI漂流匹配一旦完成，绑定收件人后不能撤回（模拟“寄出即不可控”）|
|模型迭代机制|所有行为在小批量灰度中进行评估，不影响主线体验|

---

## **八、与其他模块接口说明**

|**模块**|**描述**|
|---|---|
|写信系统|灵感卡片 → 引导用户写信 → 完成后支持 AI 匹配或 AI 笔友投送|
|条码系统|匹配成功后将收件人 OP Code 写入条码绑定项|
|信使系统|AI 中转漂流信需系统调度信使 → 投递更新状态|
|信件博物馆系统|与用户公开信件 API 联动，提取内容并自动策展归类|

---

## **九、当前实现状态（2025年1月）**

### **9.1 已实现功能**

#### **核心功能实现**
- ✅ **自由笔友匹配** - 完整实现基于信件内容的智能匹配算法
- ✅ **云中锦书** - 8种预设AI人设，支持长期对话和记忆保持
- ✅ **角色驿站** - 多角度回信建议系统，支持自定义角色
- ✅ **写作灵感** - 每日主题和个性化写作提示生成

#### **技术架构**
- ✅ **多AI提供商支持** - OpenAI、Claude、SiliconFlow三方集成
- ✅ **动态配额管理** - 自动故障转移和配额限制
- ✅ **完整API体系** - RESTful API设计，前后端分离
- ✅ **安全机制** - JWT认证、角色权限控制

### **9.2 技术实现细节**

#### **后端实现** (`/backend/internal/services/ai_service.go`)
```go
// AI服务核心功能
- MatchPenPal()     // 笔友匹配
- GenerateReply()   // AI回信生成
- GetInspiration()  // 写作灵感
- GenerateReplyAdvice() // 回信建议
- CurateLetters()   // 信件策展

// 多提供商支持
- callOpenAI()      // OpenAI API调用
- callClaude()      // Claude API调用  
- callSiliconFlow() // SiliconFlow调用
```

#### **前端实现** (`/frontend/src/app/(main)/ai/page.tsx`)
- 四大功能模块Tab切换界面
- 实时认证状态检查
- 加载状态和错误处理
- 响应式设计支持

### **9.3 数据模型实现**

```go
// AI配置表
type AIConfig struct {
    ID           string
    Provider     string  // openai/claude/siliconflow
    APIKey       string
    Model        string
    Temperature  float64
    MaxTokens    int
    IsActive     bool
    Priority     int
    DailyQuota   int
    UsedQuota    int
    QuotaResetAt time.Time
}

// AI使用记录
type AIUsageLog struct {
    ID           string
    UserID       string
    TaskType     string  // match/reply/inspiration/curate
    TaskID       string
    Provider     string
    Model        string
    InputTokens  int
    OutputTokens int
    TotalTokens  int
    Status       string
    ErrorMessage string
    CreatedAt    time.Time
}

// AI回信建议
type AIReplyAdvice struct {
    ID              string
    LetterID        string
    UserID          string
    PersonaType     string
    PersonaName     string
    PersonaDesc     string
    Perspectives    string // JSON数组
    EmotionalTone   string
    SuggestedTopics string
    WritingStyle    string
    KeyPoints       string
    DeliveryDelay   int
    ScheduledFor    *time.Time
    Provider        string
    CreatedAt       time.Time
    UsedAt          *time.Time
}
```

### **9.4 性能与限制**

|**指标**|**当前实现**|**PRD要求**|**状态**|
|---|---|---|---|
|AI匹配延迟|2-3秒|1小时以内|✅ 优于预期|
|云中锦书回信|模拟延迟2秒|8-24小时|⚠️ 需调整为真实延迟|
|每日灵感限制|未限制|最多2条/天|❌ 待实现|
|配额管理|已实现|按用户限制|✅ 已实现|

### **9.5 安全实现**

- ✅ API密钥环境变量配置
- ✅ 用户级别使用配额
- ✅ 内容过滤（基础实现）
- ⚠️ 敏感信息检测（待加强）

### **9.6 待优化项**

1. **慢节奏机制** - 当前回信延迟为模拟，需改为真实延迟队列
2. **灵感推送限制** - 需增加每日推送数量限制
3. **内容安全** - 加强敏感信息和不当内容检测
4. **UI优化** - 移动端适配需进一步完善
5. **缓存机制** - AI响应缓存以减少API调用

### **9.7 集成状态**

|**集成模块**|**状态**|**说明**|
|---|---|---|
|用户认证|✅ 完成|JWT认证，支持登录状态检查|
|信件系统|✅ 完成|可获取信件内容进行AI处理|
|博物馆系统|⚠️ 部分|AI策展API已实现，待前端集成|
|通知系统|❌ 待集成|AI回信通知功能待实现|

---

## **十、下一步计划**

1. **完善慢节奏机制** - 实现真实的延迟队列系统
2. **增强内容安全** - 集成更强大的内容审核能力
3. **优化用户体验** - 改进加载状态、错误提示
4. **扩展AI能力** - 增加更多AI人设和场景
5. **性能优化** - 实现智能缓存和预加载
