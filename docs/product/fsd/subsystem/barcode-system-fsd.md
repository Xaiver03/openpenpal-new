## **一、模块概述**

条码系统是 OpenPenPal 信件物流的**唯一身份识别机制**，确保每封信件在平台上的追踪、分发、派送与查阅均有标准化的数据入口。所有信件（实体或电子）必须绑定一个唯一条码，该条码与写信内容、OP Code 编码、信封等形成强关联。

---

## **二、核心功能列表**

|**功能模块**|**描述**|
|---|---|
|条码生成|每封新信件生成唯一编号并以二维码形式输出 PDF 贴纸|
|条码绑定机制|首次扫码时填写投递目标（OP Code）并锁定至该条码|
|状态追踪与更新|每次物流状态更新由信使扫码触发并记录|
|防篡改与校验机制|条码不可重复使用、篡改或绑定多条信件|
|条码库存管理|可预生成一批条码供实体信封提前贴附（商店/自提点用）|
|绑定信封关系|条码与信封编号一一对应，防止冒用或贴错|
|失效与回收逻辑|超过有效期未绑定将自动作废；已绑定不可再修改收件人信息|

---

## **三、条码生命周期图**

```
stateDiagram
[*] --> 未激活
未激活 --> 已绑定: 首次扫码填写 OP Code
已绑定 --> 投递中: 信使扫码标记收件
投递中 --> 已送达: 最后一次扫码完成
任意状态 --> 作废: 条码被撤销 / 超期
```

---

## **四、条码结构与样式**

### **4.1 编码结构建议**

条码编号统一采用 8位字母数字混合，示例：OP7X1F2K

> 可选加密编码方式（例如 base62 编码）

### **4.2 条码样式**

- 二维码（标准黑白二维码）
    
- 下方展示纯文本编号
    
- 附加字段（可选印刷）：学校简称、信件类型 icon、小贴士（扫码后填写收件人）

---

## **五、使用方式入口**

|**方式**|**说明**|
|---|---|
|商店/自提领取|四级信使批量生成条码贴纸，放置在商店销售或供用户领取|
|L4信使批量生成|仅四级信使有权限通过系统批量生成条码，用于销售和发放|
|管理端导入|管理员支持上传指定条码列表用于城市活动发行|

---

## **六、接口设计**

### **6.1 创建条码（POST**

### **/api/barcodes**

### **）**

|**字段**|**类型**|**描述**|
|---|---|---|
|letter_id|string|可选。关联信件编号，若从写信流程发起|
|source|string|生成来源：write-page / admin / batch-request|
|type|string|qr（二维码）/ numeric（编号型）|

**返回值：**

```
{
  barcode_id: "OP7X1F2K",
  pdf_url: "/barcode/OP7X1F2K.pdf",
  status: "unactivated"
}
```

---

### **6.2 绑定条码信息（PATCH**

### **/api/barcodes/:id/bind**

### **）**

|**字段**|**类型**|**描述**|
|---|---|---|
|recipient_code|string|必填。OP Code 编码|
|letter_id|string|必填。信件编号|
|envelope_id|string?|可选。信封编号（用于绑定）|

**触发：扫码后填写提交**

---

### **6.3 更新物流状态（PATCH**

### **/api/barcodes/:id/status**

### **）**

|**字段**|**类型**|**描述**|
|---|---|---|
|status|enum|picked / in_transit / delivered / failed|
|operator_id|string|扫码信使的 user_id|

---

## **七、数据结构（简要）**

```
Barcode {
  id: string,
  code: string, // 条码编号
  status: "unactivated" | "bound" | "in_transit" | "delivered" | "expired",
  letter_id: string,
  recipient_code: string,
  envelope_id?: string,
  created_by: string,
  created_at: datetime,
  scanned_log: ScanEvent[]
}
```

---

## **八、安全机制**

|**类型**|**说明**|
|---|---|
|唯一性校验|编号唯一，写入数据库前查重|
|状态锁定|条码一旦绑定即不可解绑或修改接收编码|
|加密识别码生成|可对条码内容做 base64 加盐或签名验证|
|滥用监控|同一IP / 账户生成频率超限 → 限流处理|
|操作日志|所有扫码行为带 time + location + user_id 日志记录|

---

## **九、异常与边界处理**

|**情况**|**处理方式**|
|---|---|
|条码重复使用|拒绝绑定，提示“该条码已被使用”|
|条码已过期|提示失效 → 提供重新生成新条码流程|
|条码扫描无响应|检查是否正确绑定 / 是否仍为激活状态|
|用户误贴错误信封条码|提供扫码撤回请求，但需经二级信使审核后方可重置|

---

## **十、与其他模块接口关系**

|**模块**|**描述**|
|---|---|
|写信系统|所有信件需绑定条码才能进入平台流转|
|信使系统|信使扫码更新任务状态即写入条码系统|
|编码系统|条码绑定时需校验收件人 OP Code 合法性|
|信封系统|条码可与信封编号一一绑定，防伪机制同步设计|
|AI子系统|AI漂流匹配完成后，系统将为信件绑定收件编码并写入条码记录|
