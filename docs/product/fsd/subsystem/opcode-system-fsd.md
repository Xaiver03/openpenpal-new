## **一、模块定位**

OpenPenPal 编码系统（OP Code）为每个可投递地址生成唯一的六位编码，用于定位宿舍、商店等实际投递目标点。系统具备：

- 地址标准化
    
- 用户隐私保护
    
- 信使权限控制
    
- 数据可查询、可追踪、可授权等能力

---

## **二、编码结构与管理规则**

|**位数**|**含义**|**示例**|**维护者**|**可见性**|
|---|---|---|---|---|
|前两位|学校/城市编码|PK|四级信使（城市）|✅ 可公开查询|
|第三四位|楼栋/片区编码|5F|三级信使（学校）|✅ 可公开查询|
|第五六位|宿舍号/商店点位编码|3D|二级信使 / 用户自申请|🔒 默认私密，仅在投递中可见|

📌 示例完整编码：PK5F3D

---

## **三、核心功能模块**

### **3.1 编码注册与绑定**

- 用户注册填写前4位编码（例：PK5F），用于确认所属学校与片区
    
- 若希望成为可接收地址（宿舍或商店）：
    
    - 可选择两位后缀（如 3D）
        
    - 发起申请，由二级信使审批后绑定该用户地址
        
    - 成功绑定后该编码唯一对应该地址，成为“投递目标”

### **3.2 编码查询系统**

- 提供查询学校所属编码段的能力
    
- 展示公开的公共点位（如商店）
    
- 若未设置后两位，则默认为“不可接收”状态（即 PK5F00）

### **3.3 权限授权与隐私控制**

|**角色**|**可见范围**|
|---|---|
|一级信使|执行任务时可见完整编码（含后两位）|
|二级信使|审核点位/宿舍，维护5–6位段|
|普通用户|仅可见自己填写/公开的编码|
|所有用户|可查学校/片区编码（前四位）|

---

## **四、用户编码申请流程**

```
graph TD
A[用户注册/写信] --> B[填写学校 + 片区编码（前4位）]
B --> C{是否成为接收点}
C -- 否 --> D[默认编码为 PK5F00]
C -- 是 --> E[填写后两位编码，如 3D]
E --> F[提交点位申请]
F --> G[二级信使审核]
G -- 通过 --> H[编码绑定宿舍/商店]
```

---

## **五、API 接口设计（简化）**

### **5.1 查询可用编码**

**GET** /api/opcode/query?school=PK

**返回示例**：

```
{
  "school": "PK",
  "zones": ["5F", "6A", "3B"],
  "public_points": ["PK5FSP"]  // 示例商店编码
}
```

---

### **5.2 点位申请**

**POST** /api/opcode/apply

请求参数：

```
{
  "user_id": "user_123",
  "base_code": "PK5F",
  "suffix_code": "3D",
  "type": "dorm",  // or "store"
  "desc": "5号楼3D宿舍"
}
```

---

### **5.3 编码验证**

**GET** /api/opcode/validate?code=PK5F3D

返回内容包括：

- 是否存在
    
- 是否为公开地址
    
- 是否绑定宿舍或商店
    
- 当前用户是否有查看权限

---

## **六、数据结构设计（简要）**

```
OPCode {
  code: string,            // "PK5F3D"
  base_code: string,       // "PK5F"
  suffix_code: string,     // "3D"
  owner_id: string,        // 用户 ID
  type: "dorm" | "store",
  is_public: boolean,
  approved: boolean,
  created_at: datetime
}
```

---

## **七、安全与隐私策略**

|**机制**|**描述**|
|---|---|
|后两位默认隐藏|非公开点位仅信使在投递任务中可见|
|绑定唯一性|编码一经绑定，不得由他人占用|
|非法组合拦截|编码结构不合法时禁止注册|
|查询访问控制|控制查询接口返回结果的粒度和范围|

---

## **八、异常与冲突处理**

|**异常场景**|**系统行为**|
|---|---|
|编码已存在|阻止注册，提示选择其他后缀|
|未经审批强绑后两位|无法进入投递任务系统|
|被注销或退役点位|系统自动回收，允许他人重新申请|

---

## **九、与其他子系统关系**

|**模块**|**描述**|
|---|---|
|信封系统|信封派发与使用需依赖编码前两位确定活动区域|
|条码系统|条码绑定信件时必须填写合法编码|
|信使系统|信使权限授予基于编码段，派送任务限制在授权区域|
|AI子系统|AI投递任务中根据编码密度与分布匹配收件人|
|写信系统|收件人必须填写编码，决定投递目标与任务生成逻辑|
