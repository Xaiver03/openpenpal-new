## **一、模块定位**

  

任务调度系统是平台的“自动化引擎”，用于定时执行与事件驱动的任务操作，覆盖：

- 📮 实体信件物流状态自动超时更新
    
- ⏳ 未来信定时解锁
    
- 📢 AI信件定时回信
    
- 📨 信封征集活动自动开启与关闭
    
- 🗂 数据清理与归档
    
- 🧭 功能开关定时切换（如模块上线/封锁）
    

  

目标是保持平台运转“准时、有序、无需人工干预”。

---

## **二、任务类型分类**

|**任务类型**|**描述**|**周期/触发条件**|
|---|---|---|
|🕒 定时任务|在指定时间点执行一次，如未来信开放、AI发送回信|设定时间|
|🔁 周期性任务|每天/每小时/每周执行，如每日签到刷新、每晚发送信封提醒邮件|固定周期|
|🧠 条件触发任务|满足条件立即执行，如条码激活 → 启动信件绑定流程|事件驱动|
|🧹 后台清理任务|清理无效记录、过期信件草稿、未绑定条码等|每日/每周|
|📬 状态更新同步任务|若信件7日未派送 → 自动标记“待重新调度”；漂流信无人响应 → 转AI匹配|业务超时|

---

## **三、典型任务清单（建议实现）**

|**任务名称**|**描述**|**时间策略**|
|---|---|---|
|未来信发布|自动解锁定时信件，并提醒收信人|每10分钟检查一次|
|AI笔友定时回信|每位AI笔友用户隔2–3天回一封信（需冷却）|每小时调度一次|
|信封征集自动关闭|每轮信封投稿到达截止日期 → 自动关闭|每日 00:30 调度|
|信件状态清理|7日未绑定条码的信 → 移入“草稿清理区”|每日 03:00 清理|
|超时信件自动提示|领取任务后48h未送达 → 通知信使/转他人|每1小时执行|
|活动模块上线/下线切换|功能模块如AI/漂流馆 → 到点自动启用/关闭|精确到分钟的定时任务|
|定时推送“写作灵感卡”|每晚8点推送写作建议（邮件/App通知）|每日 20:00 执行|

---

## **四、系统设计建议**

  

### **技术方案建议**

|**组件**|**技术选型**|**用途**|
|---|---|---|
|调度核心|[gocron](https://github.com/go-co-op/gocron) / cron / Quartz|注册定时任务|
|队列系统|Redis Stream / RabbitMQ|异步任务入队，支持失败重试|
|延迟任务队列|Sidekiq + Redis / custom delay bucket|AI回信 / 未来信释放|
|日志与监控|Prometheus + Grafana|每任务耗时 / 成功率监控|

---

## **五、任务配置结构（可支持后台配置）**

```
ScheduledTask {
  id: string;
  name: string;
  type: "cron" | "delayed" | "event";
  cron_expression?: string;
  trigger_event?: string;
  payload_template: object;
  handler: string; // 对应执行函数名
  enabled: boolean;
  last_executed_at: datetime;
  retry_policy?: { max_retries: number; backoff: string };
}
```

---

## **六、接口示例（管理后台任务配置）**

  

### **获取所有任务状态**

  

GET /api/admin/tasks

  

返回：

```
[
  {
    "name": "Release Future Letters",
    "cron": "*/10 * * * *",
    "last_run": "2025-07-25T12:00:00Z",
    "status": "success"
  }
]
```

---

## **七、安全与防护设计**

|**风险点**|**防护措施**|
|---|---|
|任务执行失败|支持重试机制，记录错误日志，告警到 Sentry/邮箱|
|重复执行/并发|所有任务执行加锁（基于 Redis 分布式锁）防止双执行|
|时区错乱|所有任务基于 UTC 存储 + 本地时间配置展示|
|恶意触发事件型任务|所有事件型任务加验签，确保任务触发方可信|
