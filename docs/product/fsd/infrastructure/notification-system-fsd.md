## **一、模块定位**

通知系统负责以“温柔但高效”的方式，将平台各类信息传达给用户、信使与管理员，覆盖状态提醒、任务分配、回信通知、系统更新等关键场景。支持多通道（站内、邮件、短信）与多类型（系统、互动、任务）通知管理。

---

## **二、通知类型一览**

|**类型**|**示例内容**|**目标用户群体**|
|---|---|---|
|📬 写信成功通知|“你的信件已生成，扫码后记得贴到信封投递哦”|写信人|
|📦 投递进度更新|“信件已由信使领取，预计今晚送达宿舍”|写信人 & 收信人|
|💌 回信提醒|“你收到了一封来自PK5F**的回信，是否查看？”|原始写信人|
|🧠 AI回信推送|“AI笔友在月光下给你写了回信，点此查看”|用户（启用AI）|
|👤 权限变更提醒|“你已被授予二级信使权限，记得查看任务中心”|信使申请用户|
|🛠 系统公告|“7月城市信封征集开启，投稿被采纳即奖励200元！”|全体用户|
|📮 点位申请审批|“你的宿舍已成为可公开收信点，编码PK5F3D 生效”|用户|

---

## **三、功能结构图**

```
graph TD
A[各业务模块触发事件] --> B[通知中心]
B --> C[发送器队列]
C --> D1[站内信模块]
C --> D2[邮件模块]
C --> D3[短信接口]
D1 --> E[用户消息中心]
```

---

## **四、通知数据结构设计**

```
Notification {
  id: string
  user_id: string
  type: "system" | "task" | "letter" | "ai" | "logistics"
  title: string
  content: string
  is_read: boolean
  created_at: datetime
  redirect_url?: string       // 可跳转操作页
  channel: "inbox" | "email" | "sms"
}
```

---

## **五、接口设计（站内信为主）**

### **5.1 获取当前用户通知**

GET /api/notifications

**返回**：

```
[
  {
    "type": "letter",
    "title": "你收到了一封回信",
    "content": "来自PK5F**的新信件已送达",
    "is_read": false,
    "redirect_url": "/inbox/letter_123"
  }
]
```

---

### **5.2 标记已读**

POST /api/notifications/read

```
{ "notification_id": "notif_456" }
```

---

## **六、站内展示建议**

- 用户中心页面嵌入“通知中心”模块（红点提醒）
    
- 支持按类型筛选（互动/系统/AI/物流）
    
- 通知卡片格式：图标 + 摘要 + 跳转按钮
    
- 信使端支持移动设备 push 通知（如任务更新）

---

## **七、用户设置项（通知偏好）**

```
NotificationPreferences {
  user_id: string
  allow_sms: boolean
  allow_email: boolean
  letter_updates: boolean
  ai_letters: boolean
  admin_announcements: boolean
}
```

- 设置入口嵌入个人主页「通知偏好」
    
- 可开启/关闭 AI 回信提示、邮件提醒等子项
    
- 重要内容（如封禁、权限调整）不可关闭

---

## **八、发送机制建议（可异步队列）**

|**模块**|**建议方式**|
|---|---|
|写信 / 回信|同步触发 + async push|
|信使任务 / 审批|定时批量通知 or 主动推送机制|
|公告类消息|管理后台批量广播 +邮件同步发送|
|投递进度提醒|Webhook or 后端定时检查更新|

---

## **九、安全 & 合规点**

|**风险控制点**|**说明**|
|---|---|
|过度打扰|默认仅站内提醒，敏感操作才触发邮件或短信|
|用户隐私|通知中避免暴露信件内容、完整编码等敏感信息|
|拒收通知机制|允许用户对非核心通知进行关闭或忽略操作|
|发送频率控制|每类通知设置最短间隔（如 AI 回信每24h最多1次）|
