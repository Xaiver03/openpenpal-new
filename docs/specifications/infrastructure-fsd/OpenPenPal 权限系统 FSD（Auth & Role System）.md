## **一、模块定位**

权限系统为 OpenPenPal 提供 **分角色访问控制（RBAC）** 与 **基于编码的地理权限粒度授权**，确保用户、信使、管理员、AI系统访问范围受控，支持审批机制、敏感操作管控与系统安全。

---

## **二、核心角色定义**

|**角色代号**|**中文称呼**|**权限范围**|
|---|---|---|
|user|普通用户|写信、回信、购买信封、编辑资料|
|messenger1|一级信使|可见对应点位编码、执行扫码派送、提交派送状态|
|messenger2|二级信使|管理片区投递点位、审批点位申请、查看片区内所有任务|
|messenger3|三级信使|管理本校信封、审批/指派一级二级信使、维护校级编码（3–4位）|
|messenger4|四级信使|管理城市级学校开通、更新城市编码（1–2位）、设置活动信封|
|admin|平台管理员|拥有所有权限，支持后台查看/审核/封禁等|

---

## **三、权限控制模型设计**

### **3.1 资源访问权限矩阵**

|**功能/资源**|**user**|**M1**|**M2**|**M3**|**M4**|**admin**|
|---|---|---|---|---|---|---|
|查看公开信件|✅|✅|✅|✅|✅|✅|
|填写地址编码|✅|✅|✅|✅|✅|✅|
|信封商城购买|✅|✅|✅|✅|✅|✅|
|扫码执行任务|❌|✅|✅|✅|✅|✅|
|审批点位/编码|❌|❌|✅|✅|✅|✅|
|信使权限管理|❌|❌|❌|✅|✅|✅|
|城市级开通学校|❌|❌|❌|❌|✅|✅|
|内容封禁/用户黑名单管理|❌|❌|❌|❌|❌|✅|

---

### **3.2 编码段权限控制机制（范围边界）**

|**信使等级**|**可操作编码段示例**|**权限说明**|
|---|---|---|
|一级信使|PK5F3D（完整编码）|仅能投递自己宿舍/绑定点位|
|二级信使|PK5F**|宿舍/店铺申请审批、任务分配|
|三级信使|PK**|管理所有 PK 编码的学校片区|
|四级信使|全城市（多个学校）|开通新学校、赋予学校编码权限|

---

### **3.3 信使权限成长路径（审批流）**

```
graph LR
U[普通用户] -- 申请 --> M1[一级信使]
M1 -- 推荐 --> M2[二级信使]
M2 -- 提升申请 --> M3[三级信使]
M3 -- 推荐/考核 --> M4[四级信使]
```

- 每级信使由上一级信使或平台管理员审批
    
- 四级信使授予城市级控制权，并可在限定学校中任命新三级信使

---

## **四、接口结构（简要）**

### **4.1 获取当前用户角色**

GET /api/auth/role

**返回**：

```
{
  "role": "messenger2",
  "authorized_code_range": ["PK5F**"]
}
```

---

### **4.2 请求升级信使等级**

POST /api/auth/upgrade-request

```
{
  "target_role": "messenger2",
  "motivation": "我希望帮助片区内同学提升送信效率",
  "related_codes": ["PK5F"]
}
```

---

### **4.3 判断用户操作权限**

GET /api/auth/check-permission?operation=approve_point&code=PK5F3D

**返回**：

```
{
  "authorized": true
}
```

---

## **五、安全控制与风控设计**

|**风险点**|**风控措施**|
|---|---|
|用户越权操作|所有操作请求均需权限校验（按编码 + 角色）|
|多人共享账号|限制 IP、设备频繁变动自动提示二次认证|
|滥用审批权/越权修改权限|需记录每次权限变更日志并双重审核|
|信使腐败/违规行为|上级信使可举报/封禁下级；严重可上报平台封禁|

---

## **六、权限系统与其他模块交互图**

```
graph TD
A[用户系统] --> B[权限系统] --> C[写信/扫码模块]
B --> D[编码模块权限判断]
B --> E[信使中心功能开放]
F[后台管理系统] --> B
```

---

## **七、开发与部署建议**

- 使用基于 Role + CodePrefix 的组合权限控制模型
    
- 所有访问受控 API 应通过中间件统一检查权限
    
- 重要权限操作记录操作日志，便于审计与异常追踪

---

是否继续输出下一个基建系统（如内容审核系统、文件系统或通知权限整合）？✅