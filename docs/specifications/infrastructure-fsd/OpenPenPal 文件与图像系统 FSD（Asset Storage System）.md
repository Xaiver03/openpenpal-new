后续会统一提供数据库服务，目前只需要功能层实现。

## **一、模块定位**

文件与图像系统（Asset）为 OpenPenPal 提供统一的**图像与附件存储上传机制**，支持：

- 📷 手写信照片（上传展示或回信）
    
- ✉️ 信封设计图（用户投稿、信使创建）
    
- 📎 条码贴纸（PDF生成下载）
    
- 👤 用户头像、展示封面图等资源

目标是提供安全、高可用、带访问控制的存储方案，同时支持 CDN 加速与内容反审查。

---

## **二、存储类型与结构设计**

|**类型**|**描述**|**访问权限**|
|---|---|---|
|信件照片（手写）|上传用于展示、存档或回信|仅寄收双方可访问（授权后可公开）|
|信封设计图|PNG/JPG，用户设计上传后提交信使审批使用|所有人可访问（经审核）|
|条码贴纸 PDF|用户写信时生成的二维码文件|写信人可下载（唯一绑定）|
|用户头像/展示图|用户主页素材|所有人可见|
|AI输出图片（如卡片）|AI辅助信件中生成的插图（可选）|用户自己或公开展示|

文件结构推荐使用如下分层目录：

```
/assets/
  ├── users/{userId}/avatar.png
  ├── letters/{letterId}/photo.jpg
  ├── envelopes/{envelopeId}/design.png
  ├── barcodes/{barcodeId}/label.pdf
```

---

## **三、上传接口设计**

### **3.1 文件上传（统一）**

**POST** /api/assets/upload

**请求参数**（使用 FormData）：

- file：图像 / PDF 文件
    
- type: "avatar" | "letter_photo" | "envelope" | "barcode"
    
- related_id: 对应的信件/信封/条码ID

**返回**：

```
{
  "asset_url": "https://cdn.openpenpal.io/assets/letters/xxx/photo.jpg",
  "asset_id": "asset_81273"
}
```

---

## **四、访问控制逻辑**

|**资源**|**控制说明**|
|---|---|
|手写信照片|默认私密，仅寄信人和收信人 ID 匹配时可查看|
|条码贴纸 PDF|每个条码生成后仅允许当前用户下载一次|
|信封设计图|上传后进入审核队列，审核通过后进入公共CDN目录|
|用户头像|默认公开，可支持默认图像|
|AI插图|默认仅本人可见，若展示到信件博物馆，需双向授权|

---

## **五、安全机制设计**

|**风险点**|**控制措施**|
|---|---|
|非法内容上传|调用内容审核系统的图像接口进行识别审查|
|条码伪造或泄露|每个条码绑定文件需带签名字段，防止外链伪造|
|批量刷图/接口滥用|限制上传频率 + 上传大小 + 登录状态校验|
|链接泄露|所有私有链接设置 10 分钟过期的临时 Token 访问 URL|

---

## **六、图片优化与压缩策略**

|**类型**|**建议规格（尺寸）**|**压缩策略**|
|---|---|---|
|头像|256x256 px|自动压缩 ≤ 300KB|
|信封图|1080x720 px|限制 ≤ 1MB，高清展示|
|手写信照片|2480x3508 px（A4）|上传前压缩为 ≤ 1MB，保清晰|
|条码贴纸 PDF|A6 / A7 分辨率|300dpi，可用 jsPDF 生成|

---

## **七、后端存储建议**

- 可选对象存储方案：
    
    - 本地开发阶段：本地 /uploads 文件夹 + nginx 静态资源托管
        
    - 生产环境推荐：
        
        - ✅ 七牛云 / 阿里云 OSS / 腾讯云 COS
            
        - ✅ Cloudflare R2（支持全球CDN）

- 所有文件应携带 content hash 与元信息（user_id、绑定资源类型）

---

## **八、可拓展功能（未来版本）**

|**功能**|**描述**|
|---|---|
|信件图集功能|用户可上传完整信件组图，生成图集页用于展示|
|AI水印生成机制|所有 AI 插图统一打上轻量水印，区分人类/AI内容|
|下载凭证授权系统|仅允许扫码人下载对应条码文件（如信件收件人）|
|CDN访问控制集成|与用户权限同步，对私有文件设置 Referer 限制或签名链接机制|
