# 四级信使系统修复方案

## 问题总结（用户反馈）

### 1. 硬编码 + 角色扩展未跟进
- **问题**: 系统支持了新的四级信使角色，却没有同步更新 UI 逻辑
- **本质**: 缺乏统一的角色映射机制，写死逻辑，一旦新增角色就要手动改

### 2. 身份校验逻辑错误  
- **问题**: login 的 JWT 结构改了，但 /me 接口还用旧逻辑匹配 ID
- **本质**: 没有统一封装 userId 的生成/匹配方式，完全靠手写字符串拼接

### 3. 权限判断/路由拦截逻辑未配置
- **问题**: 登录成功了，页面不显示内容
- **本质**: 没有做登录跳转或权限 guard 配置

## 系统性修复方案

### ✅ 已完成
1. **角色映射字典** - `src/lib/auth/user-utils.ts`
2. **封装用户身份校验函数** - `findCourierTestAccount`, `generateUserId`
3. **调试工具生产环境隔离** - 已有 `process.env.NODE_ENV` 判断

### 🔄 正在修复
4. **修复 /api/auth/me 500 错误**
5. **统一 userId 生成逻辑**

### 📝 待实现
6. **登录成功统一跳转**
7. **Mock 测试所有账号**  
8. **E2E 自动化测试**

## 当前状态

### 登录测试结果
```
✅ 四级信使登录成功 - courierInfo: level 4, points 764, tasks 51
✅ 三级信使登录成功 - courierInfo: level 3, points 1211, tasks 65  
✅ 二级信使登录成功 - courierInfo: level 2, points 1348, tasks 46
✅ 一级信使登录成功 - courierInfo: level 1, points 1259, tasks 47
❌ /api/auth/me 接口 500 错误
```

### 权限验证结果
```
✅ Level 2+ 可访问下级信使API  
✅ Level 1 被正确拒绝访问(403)
✅ 所有级别权限数量正确 (4,8,11,14)
```

## 下一步行动

1. **立即修复**: `/api/auth/me` 接口错误
2. **页面跳转**: 登录后自动跳转到对应管理页面
3. **完整测试**: 端到端测试各级信使界面

## 技术债务清单

1. **用户ID格式不一致** - 需要统一为简单格式
2. **错误处理不完善** - API错误需要标准化  
3. **缺少登录跳转逻辑** - 登录成功后应该自动跳转
4. **前端权限判断复杂** - 需要简化权限检查逻辑