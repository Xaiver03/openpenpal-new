# OpenPenPal 测试账号

## 🔐 登录接口详情

### 登录端点

**Endpoint**: `POST /api/v1/auth/login`

**Request Format**:
```json
{
  "username": "username_or_email",
  "password": "password"
}
```

**Response Format**:
```json
{
  "code": 200,
  "message": "Login successful",
  "data": {
    "token": "JWT_TOKEN_HERE",
    "user": {
      "id": "user-id",
      "username": "username",
      "email": "email",
      "nickname": "nickname",
      "role": "role",
      "school_code": "school_code",
      "is_active": true,
      "created_at": "timestamp",
      "updated_at": "timestamp"
    },
    "expires_at": "2025-08-02T12:00:00Z"
  }
}
```

### 密码验证详情

- **加密算法**: bcrypt
- **BCrypt Cost**: 12 (可通过 `BCRYPT_COST` 环境变量配置)
- **验证方法**: `bcrypt.CompareHashAndPassword()`
- **源码位置**: `backend/internal/services/user_service.go` 第112行

### JWT Token 详情

- **过期时间**: 系统设置可配置（默认24小时）
- **包含信息**: User ID, Role, Expiry time
- **使用方式**: `Authorization: Bearer <token>`

## 🚀 当前数据库中的测试账号 (2025-08-02更新)

### ⚠️ 重要说明
当前数据库中的实际用户与原设计文档有差异。以下是**实际可用**的账号：

### 🔐 当前可用账号

#### 1. 超级管理员
```
用户名: admin
密码: password
邮箱: admin@openpenpal.com
角色: super_admin
权限: 全系统管理权限
```

#### 2. 一级信使账号
```
用户名: courier_level1
密码: password
邮箱: courier_level1@openpenpal.com
角色: courier_level1 - 基础投递信使
管理范围: 宿舍楼栋、商店路径等
```

```
用户名: courier1
密码: password
邮箱: courier1@openpenpal.com
角色: courier_level1 - 基础投递信使
管理范围: 宿舍楼栋、商店路径等
```

#### 3. 普通用户
```
用户名: user1
密码: password
邮箱: user1@openpenpal.com
角色: user
权限: 写信、收信、查看信件
```

### ❌ 当前缺失的账号（需要创建）
- `courier_level2` (二级信使)
- `courier_level3` (三级信使)
- `courier_level4` (四级信使)
- `alice` (普通用户)
- `bob` (普通用户)

## 🚀 四级信使系统设计（待实现）

根据《信使系统PRD》，OpenPenPal采用严格的四级信使管理体系：

### 📋 信使分级结构

| **等级** | **称谓** | **管理范围** | **核心权限** |
|---------|---------|------------|------------|
| 四级信使 | 城市负责人 | 所在城市所有学校 | 开通新学校，城市级物流调度，设计城市活动信封，管理前两位编码 |
| 三级信使 | 校区负责人 | 所在学校（如北大） | 任命二级信使，设计校内信封，管理3-4位编码段，调度本校物流 |
| 二级信使 | 片区协调员 | 宿舍区/楼栋组/商业片区 | 管理5-6位编码段，审核新点位申请，分发任务给一级信使 |
| 一级信使 | 基础投递信使 | 宿舍楼栋、商店路径等 | 领取任务，扫码更新条码状态，完成实际派送流程 |

### 🎯 设计中的四级信使测试账号

#### 1. 四级信使（城市负责人）
```
用户名: courier_level4
密码: secret (待创建)
邮箱: courier4@openpenpal.com
角色: 四级信使 - 城市负责人
管理范围: 所在城市所有学校
核心权限: 
- 开通新学校
- 城市级物流调度
- 设计城市活动信封
- 管理前两位编码
- 任命三级信使
```

#### 2. 三级信使（校区负责人）
```
用户名: courier_level3
密码: secret (待创建)
邮箱: courier3@openpenpal.com
角色: 三级信使 - 校区负责人
管理范围: 所在学校（如北大）
核心权限:
- 任命二级信使
- 设计校内信封
- 管理3-4位编码段
- 调度本校物流
- 审核信使成长申请
```

#### 3. 二级信使（片区协调员）
```
用户名: courier_level2
密码: secret (待创建)
邮箱: courier2@openpenpal.com
角色: 二级信使 - 片区协调员
管理范围: 宿舍区/楼栋组/商业片区
核心权限:
- 管理5-6位编码段（宿舍点/商店点）
- 审核新点位申请
- 分发任务给一级信使
- 片区物流协调
```

#### 4. 一级信使（基础投递信使）
```
用户名: courier_level1
密码: password (当前可用)
邮箱: courier_level1@openpenpal.com
角色: 一级信使 - 基础投递信使
管理范围: 宿舍楼栋、商店路径等
核心权限:
- 领取任务
- 扫码更新条码状态
- 完成实际派送流程
- 投递反馈
```

### 🚀 信使激励机制

根据PRD，信使系统包含以下激励机制：

| **项目** | **机制** |
|----------|---------|
| 任务完成奖励 | 每单补贴（如0.5元/封），可按月提现 |
| 排名系统 | 学校内信使排行公开展示，提供徽章、认证等荣誉 |
| 线下组织权 | 三级信使拥有活动组织权限（如"手写信节""信封设计征集"等） |
| 成长系统 | 信使等级系统：从 Lv.1 → Lv.5，解锁不同权限 |

### 📋 信使任务系统

| **功能** | **说明** |
|---------|---------|
| 任务领取 | 根据自己可见编码段领取任务（如PK5F*内所有信件） |
| 扫码登记 | 每次收信 → 扫码标记"已收件"；送信 → 扫码标记"已送达" |
| 投递路径 | 平台可查询完整路径（收件人查看） |
| 任务奖励 | 每次有效派送可获得积分/现金补贴（后续支持提现） |
| 任务反馈 | 无法投递 → 填写原因并上报上级信使 |

## 🔐 其他测试账号

### 普通用户账号（设计中，待创建）
```
用户名: alice
密码: secret (待创建)
邮箱: alice@example.com
角色: 普通用户
权限: 写信、收信、查看信件
```

```
用户名: bob
密码: secret (待创建)
邮箱: bob@example.com
角色: 普通用户
权限: 写信、收信、查看信件
```

---

## ⚠️ 注意事项

1. **这些是开发测试账号**，生产环境需要重新创建
2. **四级信使系统**是OpenPenPal的核心功能，严格按照PRD实现
3. **不要使用**旧的"高级信使"、"信使协调员"等混乱角色名
4. **权限继承**：高级信使自动继承低级信使的所有权限

### 🔍 新旧权限体系对比

#### 旧角色系统 vs 新层级系统

| **旧角色** | **新层级** | **主要区别** |
|----------|----------|-----------|
| `courier` | 一级信使 | 基本相同，执行配送任务 |
| `senior_courier` | ❌ 非层级角色 | 只是功能增强，无管理权限 |
| `courier_coordinator` | ≈ 二级信使 | 类似但不完全相同 |
| 无对应 | 三级信使 | 新增校级管理层 |
| 无对应 | 四级信使 | 新增城市管理层 |

#### 权限对比表

| **权限** | courier | senior_courier | coordinator | 2级信使 | 3级信使 | 4级信使 |
|---------|---------|----------------|-------------|---------|---------|---------|
| **基础配送** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **查看报告** | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **管理下级** | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ |
| **创建信使** | ❌ | ❌ | 限制性 | ✅ 1级 | ✅ 2级 | ✅ 3级 |
| **区域协调** | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| **城市管理** | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ |

---

## 🧪 综合测试场景

### 层级管理测试 ✅
```bash
# 场景1: 完整层级链测试
1. 四级信使创建三级信使账号
2. 三级信使创建二级信使账号
3. 二级信使创建一级信使账号
4. 验证管理链条和权限传递

# 场景2: 权限边界测试
1. 一级信使尝试访问管理界面（应被拒绝）
2. 二级信使尝试创建三级信使（应被拒绝）
3. 跨级管理测试（应被限制）

# 场景3: 权限继承测试
1. 高级信使登录后测试所有低级权限
2. 验证基础功能可用性
3. 测试管理功能层级限制
```

### 基础功能测试 ✅
```bash
# 场景4: 管理员全权限测试
用户名: admin
密码: admin123
预期: 可访问所有功能，包括层级信使管理

# 场景5: 新注册用户测试
访问: http://localhost:3000/register
预期: 注册成功，获得基础用户权限
```

### 权限功能测试 ✅
```bash
# 场景6: 层级管理界面测试
各级信使登录后，验证：
- 专属管理后台正确跳转
- 管理功能界面显示正常
- 下级信使列表和操作功能

# 场景7: 任务分配链测试
从四级到一级的任务分配和传递：
- 城市级任务下发
- 学校级任务分解
- 片区级任务分配
- 楼栋级任务执行
```

---

## 🚀 当前可用的测试命令

### 层级权限验证命令 ✅
```bash
# 验证四级信使权限
curl -H "Authorization: Bearer [4级信使token]" \
     http://localhost:3000/api/courier/city-manage

# 验证三级信使权限
curl -H "Authorization: Bearer [3级信使token]" \
     http://localhost:3000/api/courier/school-manage

# 验证二级信使权限
curl -H "Authorization: Bearer [2级信使token]" \
     http://localhost:3000/api/courier/zone-manage

# 验证一级信使权限
curl -H "Authorization: Bearer [1级信使token]" \
     http://localhost:3000/api/courier/tasks
```

### 当前运行服务状态 ✅
```bash
# 验证前端服务运行状态
lsof -i :3000  # 前端服务 (当前运行中)

# 其他服务状态检查 (当前离线)
lsof -i :8000  # API网关 (离线)
lsof -i :8001  # 写信服务 (离线)
lsof -i :8002  # 信使服务 (离线)
lsof -i :8003  # 管理服务 (离线)
lsof -i :8004  # OCR服务 (离线)
```

### 当前可用的测试访问 ✅
```
✅ 前端主页: http://localhost:3000
✅ 登录页面: http://localhost:3000/login
✅ 注册页面: http://localhost:3000/register
✅ 管理控制台: http://localhost:3000/admin
✅ 信使中心: http://localhost:3000/courier

✅ 层级管理后台:
  - 城市管理: http://localhost:3000/courier/city-manage
  - 学校管理: http://localhost:3000/courier/school-manage
  - 片区管理: http://localhost:3000/courier/zone-manage
  - 个人任务: http://localhost:3000/courier/tasks

❌ API网关: http://localhost:8000 (离线)
❌ 其他后端服务: 离线状态
```

---

## ⚠️ 安全提醒

### 生产环境注意事项
1. **更换所有默认密码** - 层级信使账号仅供开发测试使用
2. **禁用测试账号** - 生产环境应禁用或删除所有测试账号
3. **权限审核** - 严格审核每个层级的创建和管理权限
4. **层级验证** - 确保层级关系和权限继承正确实现

### 层级管理最佳实践
1. **上级授权** - 所有信使创建必须由上级授权
2. **权限限制** - 严格限制跨级管理和权限提升
3. **审计日志** - 记录所有管理操作和权限变更
4. **定期审查** - 定期审查信使层级关系和权限分配

---

## 📞 技术支持

### 层级信使系统状态 (2025-01-23 更新)
```
✅ 前端服务 (3000): 运行中 - 支持层级管理
✅ 四级信使体系: 完整实现
✅ 权限继承系统: 正常工作
✅ 管理后台分离: 按层级正确路由
❌ 后端服务: 离线 (使用前端模拟)

🏢 层级管理: 四级完整体系
📋 认证方式: 前端内置 + 层级权限验证
📊 数据存储: 本地内存 (重启清空)
```

---

### 🔑 密码哈希值参考

当前数据库中使用的密码哈希：
- **密码 "password"**: `$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi`

原设计文档中的密码哈希（未使用）：
- **密码 "secret"**: `$2a$10$N9qo8uLOickgx2ZMRZoMye.Lf/rSDRfYHYxX1dpIjJJNzTHFN1UTO`
- **密码 "admin123"**: `$2a$10$dwSXE/fBcbAJVy0jMZHYI.vFjjUZFYRMPpeAzcgmHd.XqwfqgOrEW`

### 📂 相关源文件

- **登录处理器**: `/backend/internal/handlers/user_handler.go` (Login 函数在第42行)
- **登录服务**: `/backend/internal/services/user_service.go` (Login 函数在第98行)
- **种子数据**: `/backend/internal/config/database.go` (测试用户从第163行开始)
- **路由配置**: `/backend/main.go` (登录路由在第184行)

### ⚠️ 登录注意事项

1. 登录端点接受用户名或邮箱作为 username 字段
2. 用户账户必须处于激活状态 (`is_active: true`) 才能登录
3. 所有信使账户都有特定的学校代码和层级
4. 数据库初始化时会自动加载种子数据
5. 密码验证使用 bcrypt，成本因子为 12，确保安全性

**最后更新**: 2025-08-02  
**版本**: v4.0.3 (数据库实际状态更新)
**更新内容**: 
- 根据数据库实际状态更新了可用账号列表
- 明确标注了当前可用账号与设计文档的差异
- 所有当前账号密码均为 "password"
- 区分了"当前可用"和"待创建"的账号

> 💡 **新功能亮点**: 
> 1. **四级信使体系**: 完整的城市-学校-片区-楼栋四级管理
> 2. **权限继承**: 高级信使自动继承所有低级权限
> 3. **分级管理**: 每级只能管理直接下级，权限边界清晰
> 4. **专属后台**: 每个层级都有专门的管理界面
> 5. **层级创建**: 上级信使可以创建和管理下级信使

> 🎯 **当前实际可用的测试账户**:
> - `admin` / `password` - 超级管理员
> - `courier_level1` / `password` - 一级楼栋信使
> - `courier1` / `password` - 一级楼栋信使（备用）
> - `user1` / `password` - 普通用户

> ⚠️ **重要说明**:
> - 新层级系统与原有角色系统并存
> - `senior_courier` 不等同于二级信使
> - 层级信使具有完整的上下级管理关系
> - 每个层级都有专属的管理后台和权限范围